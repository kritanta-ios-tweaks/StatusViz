# Cozy

Dynamic image color analyzer

![OpenPack](https://openpack.io/lib-openpack-mit-@0.5x.png "Created for OpenPack. Licensed under MIT")

### Use cases

This library was written primarily for album art color analysis, but should be able to handle just about any image. 

Your milage may vary, and edge cases may require experimentation. 

This library was built for use in [Theos](https://github.com/theos/theos) projects. I'm not quite sure how one would use it in XCode, yet. 

# Using this library

### Table of Contents:

Setup and quick start   
[Configuring Theos](#Configuring)  
[Full Example Implementation](#Full)  
[Generating a Schema](#Generate)  
[Using a Schema](#Using)  
-=-=-=-=-=-=-=-=-=-  
Generated Objects  
[CozySchema](#CozySchema)  
[CozyColor](#CozyColor)   
-=-=-=-=-=-=-=-=-=-  
Other Reference  
[Options for the Analyzer](#Analyzer)  
[Cool Tricks with CozyColors](#Cool)  
[The foundColors property in CozySchema](#FoundColors)

# Configuring Theos

To add this library to your Theos configuration, you can run the command below in Terminal

`bash <(curl -s https://raw.githubusercontent.com/KritantaDev/libCozy/master/configureTheos.sh)`

**To update your Cozy implementation, you can run `$THEOS/bin/updateCozy.sh`**

This will temporarily download install.sh from libCozy, which will place the libCozy.dylib in $THEOS/lib and the headers in $THEOS/include/Cozy

This will also generate an update script in $THEOS/bin/updateCozy.sh

# Full Implementation

In your project Makefile

```Makefile
$(TWEAK_NAME)_LIBRARIES = Cozy
```

---

In your project control file, add 

`me.kritanta.libCozy`

to your depends section

---

In the file you want to use Cozy in. 

```objc
#include <Cozy/Cozy.h>
```

```objc
// image should contain the image you want to analyze
UIImage *image = <get your artwork image>;

// options is a list of options for the color analyzer. here, we want none enabled. 
NSArray *options = @[];
// Finally, pass these to the analyzer and get our schema. 
CozySchema *schema = [CozyAnalyzer schemaForImage:image withOptions:options];

// Get the CozyColor from our schema, and then get the UIColor from that CozyColor. 
UIColor *labelColor = [[schema labelColor] getColor];
UILabel *songLabel = [UILabel new];
songLabel.text = @"Song Name";
// Set our example label's color
songLabel.color = labelColor;

UIColor *secondaryLabelColor = [[schema secondaryLabelColor] getColor];
UILabel *artistLabel = [UILabel new];
artistLabel.text = @"Artist";
artistLabel.text = secondaryLabelColor;
```

Many more colors are generated with default options. See the [CozySchema](#CozySchema) section for a full list. 

# Generate a Schema

#### Example Code

```objc
UIImage *image = <get your artwork image>;
NSArray *options = @[ @"fullBlack" ];
CozySchema *schema = [CozyAnalyzer schemaForImage:image withOptions:options];
```

# Using the Schema

#### Example code

```objc
UILabel *songLabel = [UILabel new];
...
songLabel.textColor = [[schema labelColor] getColor];
```

# CozySchema

CozySchema's are generated by a CozyAnalyzer. They will generate several variables for usage across the program. 

| Variable Name | Type | Description | 
| ------------- | ---- | ----------- |
| labelColor | CozyColor | Primary label color. Should stand out from the rest |
| secondaryLabelColor | CozyColor | Secondary Label Color. Slightly darker/lighter depending on background brightness |
| tertiaryLabelColor | CozyColor | Tertiary Label Color. Even darker/lighter than the secondary one. |
| controlColor | CozyColor | White-tinted Primary color for use on buttons and knobs |
| secondaryControlColor | CozyColor | Darker secondary color for elapsed portions of sliders and time controls |
| tertiaryLabelColor | CozyColor | Even darker tertiary color for un-elapsed portions of sliders (right side) |
| contrastColor | CozyColor | Unmodified most contrasting color found. | 
| commonColor | CozyColor | Unmodified most common color found | 
| backgroundColor | CozyColor | Background color generated | 

You can check if a background color is light using `schema.backgroundColor.b > .5`

`.b` contains the brightness of the color. See the CozyColor object description for more info. 

# CozyColor

To get a UIColor from a CozyColor, use the instance method `- (UIColor *)getColor`. This will generate a UIColor from the set r/g/b/a values. 

You shouldn't need to edit CozyColors. Using `getColor` only is recommended. But, in the event that you do, CozyColor offers some conveniences.

Upon initialization, it creates RGBA values, and then uses UIKit to generate HSV values.

**RGBA values are editable. HSB are measurements only**

CozyColor r/g/b values are measured on a scale from 0-255;

CozyColor a/h/s/v values are measured on a scale from 0-1;

Editing HSV values will not affect the color, and they should only be used for measurements. 

To get new HSV values, initialize a new instance of CozyColor. 

To initialize a CozyColor, `[[CozyColor alloc] initWithRed:r green:g blue:b];`


# Cool Tricks with CozyColors and color palettes

"Humanizing" RGB values can be a bit tricky. I've found HSB does the best job of this, which is why I've added HSV values to CozyColor. 

If you aren't familiar with HSV colors, I'd suggest playing with a some color pickers to get a good idea of how it works. **Note: HSV is not HSL**. 

HSV stands for Hue Saturation Value. Value is also often referred to as "Brightness", as well. HSB and HSV are the same thing. 

Just for quick reference, here's a 3d representation of a HSV Color space:

![HSV](https://developer.openpack.io/cozy/docs/hsb.png "HSV Color Space")

HSV values in CozyColors are stored as values between 0 and 1. 

Hue is the location on the circumference of the color wheel above. It's difficult to work with this value in a way that makes sense, and doing so is a topic for elsewhere.

Saturation is the distance from the center of the cone. 

1 = The Edge, 0 = The center

Value is the distance from the bottom of the cone. 

1 = The base (full brightness), 0 = The point (always black)

So, quickly referencing the image, you can check how bright an image is using 

`cozycolor.v`. A value below `0.2` usually means the color is fairly dark. 

A Saturation value lower than `0.15` typically means the color is very close to being greyscale. 

# Analyzer Options

| Name | Description | Overrides |
| ---- | ----------- | --------- |
| fullBlack | Allows very low brightness levels for background colors | |
| ~~paletteAPI~~ | Whenever too few colors are found, call an online color API from what was found and create a new palette **Not Yet Implemented** | |
| noFallbackGeneration | Don't try to cleverly generate a color palette when finding certain colors fail. May improve speed, but may also look bad on certain images. | paletteAPI |
| preferCoolBackground | If primary colors are much cooler (color temp) than background colors, swap the two. Looks much better in most cases. | |
| alwaysLightForeground | Use this option if you want controls to be lighter regardless of background brightness | |
| darkenBackgroundTillReadable | Use in conjunction with alwaysLightForeground to darken background till light text is readable | |
| dumb | Sacrifice a quality palette for speed. Good for when you only need a simple color. | All options above | 
| dumber | Generate a palette as quickly as possible, and only set the "primary", "secondary", and "background" variables. | All options above |
| dumbest | Only set the background variable. | All options above |

To enable an option, add the name to the array of options you pass. 

# The foundColors property in ColorSchema

You probably wont ever need this, but it's there anyways :)

The foundColors property is a `char`. I use it as a quick way to check which colors were found and which were generated. 

If you aren't familiar with C primitives, a `char` is a single byte that can hold a value between -127 and 127

Pretend the value, represented in basic binary is `00000111` (7). 

foundColor<sup>0</sup> represents whether the Secondary was found (0 if generated) (LSB 0)
foundColor<sup>1</sup> represents whether the Primary was found  
foundColor<sup>2</sup> represents whether the Background was found

If you hate bit flipping and all of this, here's a quick ref:

0 = No colors found (Greyscale palette generated)  
1 = Secondary only was found  
2 = Primary only was found  
3 = Primary and secondary were found  
4 = Background only was found  
5 = Background and secondary were found  
6 = Background and primary were found  
7 = All colors were found (none generated)  
